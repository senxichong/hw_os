# 作业八
<center>
    蔡合森 2022K8009009004
</center>
 
 **8.1**一台机器虚存采用分段机制，物理内存当前的空闲空间如下(按物理地址由小到大的顺 序):12MB, 5MB, 18MB, 20MB, 8MB, 9MB, 10MB和15MB。此时要为三个段分配空间(按时间 先后顺序): 段A申请12MB，段B申请10MB，段C申请9MB。请分别给出采用Best Fit， Worst Fit，First Fit 和 Next Fit算法下，每次分配成的空闲空间状态(按物理地址由小到大顺序)，以及每次分配所需的比较次数。
 **解**：
|算法    | 第一次分配后空闲空间状态  | 比较次数 |第二次分配后空闲空间状态  | 比较次数 |第三次分配后空闲空间状态  | 比较次数 |
|----------|---------------------------------------------|----------|---------------------------------------------|----------|---------------------------------------------|----------|
| Best Fit |  5MB, 18MB, 20MB, 8MB, 9MB, 10MB和15MB    |  1   | 5MB, 18MB, 20MB, 8MB, 9MB, 15MB|6| 5MB, 18MB, 20MB, 8MB, 15MB|5|
| Worst Fit| 12MB, 5MB, 18MB, 8MB， 8MB, 9MB, 10MB和15MB  |   8  | 12MB, 5MB, 8MB， 8MB， 8MB, 9MB, 10MB和15MB|8|12MB, 5MB, 8MB, 20MB, 8MB, 9MB, 10MB和6MB|8|
| First Fit| 5MB, 18MB, 20MB, 8MB, 9MB, 10MB和15MB |   1   |5MB, 8MB, 20MB, 8MB, 9MB, 10MB和15MB|2|5MB, 8MB, 11MB, 8MB, 9MB, 10MB和15MB|3|
| Next Fit |   5MB, 18MB, 20MB, 8MB, 9MB, 10MB和15MB  |   1   |5MB, 8MB, 20MB, 8MB, 9MB, 10MB和15MB|2|5MB, 8MB, 11MB, 8MB, 9MB, 10MB和15MB|2|


 **8.2**假设一台计算机使用32-bit的虚拟地址空间和三级页表，虚地址的划分为 8-bit | 6-bit | 6-bit | 12-bit（注：8 bit对应为第一级页表的地址，以此类推）, 请计算：
（1）该计算机系统的页大小是多少？
（2）该三级页表一共能索引多少个页？
（3）现有一个程序的代码段大小为128KB，数据段为66KB，栈大小为8KB，则在使用上述三级页表时，最少需要占用多少个物理页框？最多会占用多少个物理页框？（注：假设程序各段在地址空间中的布局可以自行决定）
（4）在上述（3）中，假设该计算机使用一级页表进行地址空间管理，则（3）中的程序需要占用多少个物理页框？
注：请写出计算过程。

**解**
(1)页大小为：$2^{12}$ = 4KB
(2)最多为 $2^{8}$ X $2^{6}$ X $2^{6}$ = $2^{20}$个
(3)
$128KB/4KB$ = 32个
$66KB/4KB$ = 17个(向上取整)
$8KB/4KB$ = 2个
较少情况：
+ 分布较为集中
+ 按页对齐

$51/64$ = 1（向上取整）这个数字是第三级页表，同理对于第一二级页表也为一，还需要一个页表储存程序（虚拟存储可以实现）
所以需要4个物理页框。
较多情况：
+ 分布分散
+ 不按页对齐

代码段需要 33 + 2 + 2 + 2 = 39（可以认为每一级页表都需要两个）
同理：数据段为 18 + 2+ 2+ 2 =24；栈需要： 2 + 2 +2 +2=8
一共需要： 71 个
（4）32+17+2 =51 
 51+ 1 =52个（需要一个一级页表）
 那么需要52个


**8.3**：假设一台计算机上运行一个进程A，该进程的地址空间大小为4 MB（页大小为4KB）。该计算机使用线性页表记录进程A的虚实映射关系，并且将A的页表都保存在内存中。该计算机CPU的TLB大小为32项，每项4B，一次TLB查询或TLB填充的延迟均为5 ns，请计算：
（1）假设该计算机使用软件处理TLB miss，且操作系统进行一次页表查询的平均延迟为120 ns，如果想让虚实地址映射的平均延迟为40 ns，那么 TLB的命中率应为多少？如果想让虚实地址映射的平均延迟不超过20 ns，那么TLB的命中率应为多少？（上述各项操作的延迟不变）
**解**：
设命中率为`m`,那么 `5m` + `(100+5+5)X(1-m)` =40;得到`m` =  0.667
同理有 `5m` + `(100+5+5)X(1-m)` =20 得到`m` = 0.905
**8.4** 现有如下C程序
```C
uint32 X[N];
int step = M, i = 0;
for(i=0;i<N;i+=step) X[i] = X[i] + 1;
```
请计算：
（1）	假设该程序运行在一台计算机上，该计算机的虚址空间为32-bit，物理地址空间为2 GB，页大小为4 KB，如果采用一级页表，则该页表的页表项一共有多少？
（2）	假设该计算机的CPU的TLB大小为32项，每项4B，那么题述程序中的M和N取值为多少时，会使得程序中循环的每一次执行都会触发TLB miss？（假设TLB初始为空）
（3）	在（2）中，M和N取值多少时，会使得程序中的循环执行时TLB hit最多？（假设TLB初始为空）
**解**：
(1) $2^{32}$/$2^{12}$ = $2^{20}$
(2) 只需要下一个相加的不在TLB中，只需要 $M >= 32$ 且 $ N > M$
(3)hit最多则$ M = 1$，N则越大，hit越多，但是应该小于等于32，那么N = 32
