# 作业十二
<center>
    蔡合森 2022K8009009004
</center>

**12.1**现有一个文件系统，它的文件块索引采用多级间址。该文件系统的inode，包含10个直接指针，1个一级间址指针，1个二级间址指针和1个三级间址指针。假设文件块大小为4KB，每个文件块对应的磁盘块地址为4B。
1) 请问该索引结构能够索引的最大文件是多大?
2) 请问一个 2GB 的文件需要几级间址?它总共有多少间址块?其中，各级间址块分别是多少? 如何找到第10,000块？
**解**：
(1)10个直接指引：10个块
1个一级间址指针：4KB/4B = 1024个块
1个二级间址指针：1024 X 1024 个块
1个三级间址指针：1024 X1024 X1024 个块
那么最大的文件就是将这些块集合起来：有 1074791434个块，大小为1074791434 X 4kb = 4299165736KB 约为4100G
(2)2GB共有 2 X1024 X1024 =2,097,152 kb 有524,288个块
需要二级指引：
    + 10 个直接指针
    + 1 个一级间址指针
    + 1 个二级间址指针
    一级间址：1024 个间址块
    二级间址：523254个




1. **直接指针**：最多能访问 10 个块，剩余 9990 个块需要通过间址索引。
2. **一级间址指针**：每个一级间址块可以访问 1024 个文件块。第10,000块在一级间址块中：
   - 第 10,000 块在第 \( \frac{10,000}{1024} \approx 9.77 \) 个一级间址块中，所以需要第 10 个一级间址块的第 \( 10,000 - 9 \times 1024 = 768 \) 块。
   - 因此，第 10 个一级间址块的第 768 个块。

找到第 10,000 块时，首先找到第 10 个一级间址块，再通过它找到第 768 块
**12.2**某用户X刚挂载了一个文件系统（假设此时该文件系统的所有inode已被加载到内存），该文件系统使用的磁盘块大小为4KB，能用到的page cache大小最大为512MB。随后，该用户执行如下所示程序A。请分析（请写出分析过程）
1) 当程序A打开fs02.ppt文件时，文件系统需要从磁盘读取几个磁盘块？
2) 假设该文件系统采用write through的缓存策略，当程序A完成对fs02.ppt的写入操作后，文件系统写入几个磁盘块？如果该文件系统采用的是write back缓存策略，那么程序A在写完fs02.ppt还未关闭文件时，文件系统写入几个磁盘块？
3) 程序A执行完成后，用户Y再次运行该程序，当程序A打开fs02.ppt时，文件系统需要从磁盘读取几个磁盘块？ 
4) 用户Y将程序A中打开的文件修改为/home/os24/fs01.ppt，并编译执行程序A，那么当程序A打开fs01.ppt时，文件系统需要从磁盘读取几个磁盘块？
注：假设（1）所有目录都只需1个磁盘块保存其内容；（2）fs01.ppt和fs02.ppt两个文件已在文件系统中存在。
程序A代码如下
```C
#define MAX (1024)
char buf[MAX];
int fd = open("/home/os24/fs02.ppt", O_CREAT | O_RDWR, 0666); 
int n=0, i=0;
if (fd < 0 ) {
perror("open");
exit(-1); 
}
for (i = 0; i < MAX; i++) {
bzero(buf, sizeof(buf)); 
sprintf(buf, "%3d\n", i);
n = write(fd, buf, strlen(buf)); 
printf("len=%d\n", strlen(buf)); 
if (n != strlen(buf)){
perror("write");
printf("length=%d, buf=[%s]", strlen(buf), buf);
}} 
close(fd);
```
**解**：
(1)`inode`已经被加载，只需要关注数据块和目录。
打开`/home` `/os24`然后打开`fs02.ppt`,每个文件需要一个磁盘块，共需要三个磁盘块
(2)
- **`write through` 缓存策略：**
  - 每次写入四字节，共有1024次
  - 程序A写入 4096 字节数据（即 4 KB），因此需要写入 1 个磁盘块。

- **`write back` 缓存策略：**
  - 数据首先写入缓存，只有在文件关闭时才会写回磁盘。
  - 在文件关闭之前，数据会先存储在缓存中，磁盘上不会有写操作。因此不会写入磁盘块
(3)
由于操作系统会将文件内容缓存到page cache中，而 `fs02.ppt` 文件已经被加载到内存中，因此再次打开该文件时，操作系统会直接从内存中读取文件数据。
(4)
`fs01.ppt` 是一个不同的文件，尽管它已经存在于文件系统中，但它的数据尚未加载到内存缓存中。因此，操作系统需要从磁盘读取该文件的数据块。需要从磁盘读取 1 个磁盘块。

